---
version: '3.7'

networks:
  cch-net:

secrets:
  rserve_password:
    file: Docker/rserve/rserve.pwd
  rserve_config:
    file: Docker/rserve/rserve.conf
  rserve_profile:
    file: Docker/rserve/profile.conf
  ssl_cert:
    file: Docker/tomcat/ssl/ssl.crt
  ssl_key:
    file: Docker/tomcat/ssl/ssl.key

services:
  cch_postgres:
    build:
      context: ./coastal-hazards-liquibase
    networks:
      cch-net:
        aliases:
          - postgres
    env_file:
      - "compose.env"
    image: cch_postgres
    ports:
      - "5432:5432"

  cch_rserve:
    build:
      context: ./Docker/rserve
    network_mode: host
    image: cch_rserve
    ports:
      - "6311:6311"
    env_file:
      - "compose.env"
    volumes:
      - type: bind
        source: ./Docker/tomcat/ssl/trust_certs
        target: /trust_certs
    secrets:
      - source: rserve_password
        target: /rserve.pwd
      - source: rserve_config
        target: /rserve.conf
      - source: rserve_profile
        target: /profile.conf

  cch_tomcat:
    build:
      context: ./Docker/tomcat
    image: cch_tomcat
    entrypoint: /bin/true

  cch_n52_wps:
    build:
      context: .
      dockerfile: ./coastal-hazards-n52/Dockerfile
    network_mode: host
    image: cch_n52_wps
    ports:
      - "8082:8082"
    depends_on:
      - cch_rserve
    volumes:
      - type: bind
        source: ./coastal-hazards-n52/docker/config/context.xml
        target: /usr/local/tomcat/conf/context.xml
      - type: bind
        source: ./coastal-hazards-n52/docker/config/server.xml
        target: /usr/local/tomcat/conf/server.xml
      - type: bind
        source: ./coastal-hazards-n52/docker/config/wps_config.xml
        target: /wps_config.xml
      - type: bind
        source: ./Docker/tomcat/ssl/trust_certs
        target: /usr/local/tomcat/ssl/trust_certs
    secrets:
      - source: ssl_cert
        target: /usr/local/tomcat/ssl/server_cert/ssl.crt
      - source: ssl_key
        target: /usr/local/tomcat/ssl/server_cert/ssl.key

  cch_portal:
    build:
      context: .
      dockerfile: ./coastal-hazards-portal/Dockerfile
    depends_on:
      - cch_keycloak
    network_mode: host
    image: cch_portal
    ports:
      - "8080:8080"
      - "8443:8443"
      - "8900:8900"
    volumes:
      - type: bind
        source: ./coastal-hazards-portal/docker/config/server.xml
        target: /usr/local/tomcat/conf/server.xml
      - type: bind
        source: ./coastal-hazards-portal/docker/config/context.xml
        target: /usr/local/tomcat/conf/context.xml
      - type: bind
        source: ./coastal-hazards-portal/docker/config/keycloak_tomcat_config.json
        target: /usr/local/tomcat/conf/keycloak.json
      - type: bind
        source: ./Docker/tomcat/ssl/trust_certs
        target: /usr/local/tomcat/ssl/trust_certs
    secrets:
      - source: ssl_cert
        target: /usr/local/tomcat/ssl/server_cert/ssl.crt
      - source: ssl_key
        target: /usr/local/tomcat/ssl/server_cert/ssl.key

  cch_geoserver:
    build:
      context: .
      dockerfile: ./coastal-hazards-geoserver/Dockerfile
    network_mode: host
    image: cch_geoserver
    ports:
      - "8081:8081"
      - "8444:8444"
    volumes:
      - type: bind
        source: ./coastal-hazards-geoserver/docker/config/server.xml
        target: /usr/local/tomcat/conf/server.xml
      - type: bind
        source: ./coastal-hazards-geoserver/docker/config/context.xml
        target: /usr/local/tomcat/conf/context.xml
      - type: bind
        source: ./Docker/tomcat/ssl/trust_certs
        target: /usr/local/tomcat/ssl/trust_certs
    secrets:
      - source: ssl_cert
        target: /usr/local/tomcat/ssl/server_cert/ssl.crt
      - source: ssl_key
        target: /usr/local/tomcat/ssl/server_cert/ssl.key

  cch_keycloak:
    image: jboss/keycloak
    networks:
      cch-net:
        aliases:
          - keycloak
    ports:
      - "8083:8083"
      - "8446:8446"
    command: ["-Djboss.socket.binding.port-offset=3"]
    environment:
      - DB_VENDOR=h2
      - KEYCLOAK_USER=admin
      - KEYCLOAK_PASSWORD=admin
      - KEYCLOAK_HTTP_PORT=8083
      - KEYCLOAK_HTTPS_PORT=8446
    volumes:
      - type: bind
        source: ./Docker/keycloak/cch_local_development_realm.json
        target: /tmp/cch_realm.json
      - type: bind
        source: ./Docker/keycloak/load_cch_realm.sh
        target: /tmp/load_cch_realm.sh
      - type: bind
        source: ./Docker/keycloak/start_cch_keycloak.sh
        target: /opt/jboss/startup-scripts/start_cch_keycloak.sh
